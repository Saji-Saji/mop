import{g4 as t,a as e,s,t as a,U as i,S as o,T as r,g as n,a1 as l,k as p,fE as u,g5 as h,l as c,cc as f,a0 as g,bz as m,m as d,bt as S,b as C,o as b,g6 as y,c7 as v,bB as w,bX as E}from"./detailed_results-l_PUj7md.chunk.js";import{t as P,h as k}from"./index-Daay-pNH.chunk.js";import{n as N,af as M,ag as x,ah as R,ai as I}from"./preset_utils-C08y0zZJ.chunk.js";const T=t=>({min:t}),V=(t,e,s)=>t.matrix[Math.imul(e,t.width)+s],z=(t,e,s,a)=>{t.matrix[Math.imul(e,t.width)+s]=a},U=t=>"function"==typeof t[Symbol.iterator]?t:Object.entries(t),A=(t,e)=>{const s=Math.round(1/e);return Math.round((t+Number.EPSILON)*s)/s},D=(t,e,s)=>{const a=V(t,e,s),i=t.variableAtPosition[t.width+e],o=t.variableAtPosition[s];t.variableAtPosition[t.width+e]=o,t.variableAtPosition[s]=i,t.positionOfVariable[i]=s,t.positionOfVariable[o]=t.width+e;const r=[];for(let n=0;n<t.width;n++){const s=V(t,e,n);Math.abs(s)>1e-16?(z(t,e,n,s/a),r.push(n)):z(t,e,n,0)}z(t,e,s,1/a);for(let n=0;n<t.height;n++){if(n===e)continue;const i=V(t,n,s);if(Math.abs(i)>1e-16){for(let s=0;s<r.length;s++){const a=r[s];z(t,n,a,V(t,n,a)-i*V(t,e,a))}z(t,n,s,-i/a)}}},O=(t,e,s,a)=>{t.push([e.variableAtPosition[e.width+s],e.variableAtPosition[a]]);for(let i=6;i<=Math.trunc(t.length/2);i++){let e=!0;for(let s=0;s<i;s++){const a=t.length-1-s,[o,r]=t[a],[n,l]=t[a-i];if(o!==n||r!==l){e=!1;break}}if(e)return!0}return!1},B=(t,e)=>{const s=[],{precision:a,maxPivots:i,checkCycles:o}=e;for(let r=0;r<i;r++){let e=0,i=a;for(let s=1;s<t.width;s++){const a=V(t,0,s);a>i&&(i=a,e=s)}if(0===e)return["optimal",A(V(t,0,0),a)];let r=0,n=1/0;for(let s=1;s<t.height;s++){const i=V(t,s,e);if(i<=a)continue;const o=V(t,s,0)/i;if(o<n&&(r=s,n=o,o<=a))break}if(0===r)return["unbounded",e];if(o&&O(s,t,r,e))return["cycled",NaN];D(t,r,e)}return["cycled",NaN]},L=(t,e)=>{const s=[],{precision:a,maxPivots:i,checkCycles:o}=e;for(let r=0;r<i;r++){let i=0,r=-a;for(let e=1;e<t.height;e++){const s=V(t,e,0);s<r&&(r=s,i=e)}if(0===i)return B(t,e);let n=0,l=-1/0;for(let e=1;e<t.width;e++){const s=V(t,i,e);if(s<-a){const a=-V(t,0,e)/s;a>l&&(l=a,n=e)}}if(0===n)return["infeasible",NaN];if(o&&O(s,t,i,n))return["cycled",NaN];D(t,i,n)}return["cycled",NaN]};var F,W,G,H={exports:{}},q=H.exports;function _(){return F||(F=1,t=H,function(){var e,s,a,i,o,r,n,l,p,u,h,c,f,g,m;a=Math.floor,u=Math.min,s=function(t,e){return t<e?-1:t>e?1:0},p=function(t,e,i,o,r){var n;if(null==i&&(i=0),null==r&&(r=s),i<0)throw new Error("lo must be non-negative");for(null==o&&(o=t.length);i<o;)r(e,t[n=a((i+o)/2)])<0?o=n:i=n+1;return[].splice.apply(t,[i,i-i].concat(e)),e},r=function(t,e,a){return null==a&&(a=s),t.push(e),g(t,0,t.length-1,a)},o=function(t,e){var a,i;return null==e&&(e=s),a=t.pop(),t.length?(i=t[0],t[0]=a,m(t,0,e)):i=a,i},l=function(t,e,a){var i;return null==a&&(a=s),i=t[0],t[0]=e,m(t,0,a),i},n=function(t,e,a){var i;return null==a&&(a=s),t.length&&a(t[0],e)<0&&(e=(i=[t[0],e])[0],t[0]=i[1],m(t,0,a)),e},i=function(t,e){var i,o,r,n,l,p;for(null==e&&(e=s),l=[],o=0,r=(n=function(){p=[];for(var e=0,s=a(t.length/2);0<=s?e<s:e>s;0<=s?e++:e--)p.push(e);return p}.apply(this).reverse()).length;o<r;o++)i=n[o],l.push(m(t,i,e));return l},f=function(t,e,a){var i;if(null==a&&(a=s),-1!==(i=t.indexOf(e)))return g(t,0,i,a),m(t,i,a)},h=function(t,e,a){var o,r,l,p,u;if(null==a&&(a=s),!(r=t.slice(0,e)).length)return r;for(i(r,a),l=0,p=(u=t.slice(e)).length;l<p;l++)o=u[l],n(r,o,a);return r.sort(a).reverse()},c=function(t,e,a){var r,n,l,h,c,f,g,m,d;if(null==a&&(a=s),10*e<=t.length){if(!(l=t.slice(0,e).sort(a)).length)return l;for(n=l[l.length-1],h=0,f=(g=t.slice(e)).length;h<f;h++)a(r=g[h],n)<0&&(p(l,r,0,null,a),l.pop(),n=l[l.length-1]);return l}for(i(t,a),d=[],c=0,m=u(e,t.length);0<=m?c<m:c>m;0<=m?++c:--c)d.push(o(t,a));return d},g=function(t,e,a,i){var o,r,n;for(null==i&&(i=s),o=t[a];a>e&&i(o,r=t[n=a-1>>1])<0;)t[a]=r,a=n;return t[a]=o},m=function(t,e,a){var i,o,r,n,l;for(null==a&&(a=s),o=t.length,l=e,r=t[e],i=2*e+1;i<o;)(n=i+1)<o&&!(a(t[i],t[n])<0)&&(i=n),t[e]=t[i],i=2*(e=i)+1;return t[e]=r,g(t,l,e,a)},e=function(){function t(t){this.cmp=null!=t?t:s,this.nodes=[]}return t.push=r,t.pop=o,t.replace=l,t.pushpop=n,t.heapify=i,t.updateItem=f,t.nlargest=h,t.nsmallest=c,t.prototype.push=function(t){return r(this.nodes,t,this.cmp)},t.prototype.pop=function(){return o(this.nodes,this.cmp)},t.prototype.peek=function(){return this.nodes[0]},t.prototype.contains=function(t){return-1!==this.nodes.indexOf(t)},t.prototype.replace=function(t){return l(this.nodes,t,this.cmp)},t.prototype.pushpop=function(t){return n(this.nodes,t,this.cmp)},t.prototype.heapify=function(){return i(this.nodes,this.cmp)},t.prototype.updateItem=function(t){return f(this.nodes,t,this.cmp)},t.prototype.clear=function(){return this.nodes=[]},t.prototype.empty=function(){return 0===this.nodes.length},t.prototype.size=function(){return this.nodes.length},t.prototype.clone=function(){var e;return(e=new t).nodes=this.nodes.slice(0),e},t.prototype.toArray=function(){return this.nodes.slice(0)},t.prototype.insert=t.prototype.push,t.prototype.top=t.prototype.peek,t.prototype.front=t.prototype.peek,t.prototype.has=t.prototype.contains,t.prototype.copy=t.prototype.clone,t}(),t.exports=e}.call(q)),H.exports;var t}const $=t(G?W:(G=1,W=_())),j=(t,e)=>({matrix:new Float64Array(t),positionOfVariable:new Int32Array(e),variableAtPosition:new Int32Array(e)}),K=(t,{matrix:e,positionOfVariable:s,variableAtPosition:a},i)=>{const{width:o,height:r}=t;e.set(t.matrix);for(let l=0;l<i.length;l++){const[s,a,n]=i[l],p=(r+l)*o,u=t.positionOfVariable[a];if(u<o)e[p]=s*n,e.fill(0,p+1,p+o),e[p+u]=s;else{const t=(u-o)*o;e[p]=s*(n-e[t]);for(let a=1;a<o;a++)e[p+a]=-s*e[t+a]}}s.set(t.positionOfVariable),a.set(t.variableAtPosition);const n=o+r+i.length;for(let l=o+r;l<n;l++)s[l]=l,a[l]=l;return{matrix:e.subarray(0,t.matrix.length+o*i.length),width:o,height:r+i.length,positionOfVariable:s.subarray(0,n),variableAtPosition:a.subarray(0,n)}},Y=(t,e)=>{let s=0,a=0,i=0;for(let o=0;o<e.length;o++){const r=e[o],n=t.positionOfVariable[r]-t.width;if(n<0)continue;const l=V(t,n,0),p=Math.abs(l-Math.round(l));p>s&&(s=p,a=r,i=l)}return[a,i,s]},Z=({tableau:t,sign:e,variables:s},a,i,{precision:o,includeZeroVariables:r})=>{if("optimal"===a||"timedout"===a&&!Number.isNaN(i)){const n=[];for(let e=0;e<s.length;e++){const[a]=s[e],i=t.positionOfVariable[e+1]-t.width,l=i>=0?V(t,i,0):0;l>o?n.push([a,A(l,o)]):r&&n.push([a,0])}return{status:a,result:-e*i,variables:n}}if("unbounded"===a){const a=t.variableAtPosition[i]-1;return{status:"unbounded",result:e*(1/0),variables:0<=a&&a<s.length?[[s[a][0],1/0]]:[]}}return{status:a,result:NaN,variables:[]}},J={precision:1e-8,checkCycles:!1,maxPivots:8192,tolerance:0,timeout:1/0,maxIterations:32768,includeZeroVariables:!1},X=(t,e)=>{const s=(t=>{const{objective:e}=t,s=U(t.constraints),a=U(t.variables),i=Array.isArray(a)?a:Array.from(a),o=[],r=[];for(let d=1;d<=i.length;d++){const[t]=i[d-1];o.push(d),r.push(d)}const n=new Map;for(const[d,S]of s){const t=n.get(d)??{row:NaN,lower:-1/0,upper:1/0};t.lower=Math.max(t.lower,S.equal??S.min??-1/0),t.upper=Math.min(t.upper,S.equal??S.max??1/0),n.has(d)||n.set(d,t)}let l=1;for(const d of n.values())d.row=l,l+=(Number.isFinite(d.lower)?1:0)+(Number.isFinite(d.upper)?1:0);const p=i.length+1,u=l+o.length,h=p+u,c=new Float64Array(p*u),f=new Int32Array(h),g=new Int32Array(h),m={matrix:c,width:p,height:u,positionOfVariable:f,variableAtPosition:g};for(let d=0;d<h;d++)f[d]=d,g[d]=d;for(let d=1;d<p;d++)for(const[t,s]of U(i[d-1][1])){t===e&&z(m,0,d,1*s);const a=n.get(t);null!=a&&(Number.isFinite(a.upper)?(z(m,a.row,d,s),Number.isFinite(a.lower)&&z(m,a.row+1,d,-s)):Number.isFinite(a.lower)&&z(m,a.row,d,-s))}for(const d of n.values())Number.isFinite(d.upper)?(z(m,d.row,0,d.upper),Number.isFinite(d.lower)&&z(m,d.row+1,0,-d.lower)):Number.isFinite(d.lower)&&z(m,d.row,0,-d.lower);for(let d=0;d<o.length;d++){const t=l+d;z(m,t,0,1),z(m,t,o[d],1)}return{tableau:m,sign:1,variables:i,integers:r}})(t),a={...J,...e},[i,o]=L(s.tableau,a);if(0===s.integers.length||"optimal"!==i)return Z(s,i,o,a);{const[t,e,i]=((t,e,s)=>{const{tableau:a,sign:i,integers:o}=t,{precision:r,maxIterations:n,tolerance:l,timeout:p}=s,[u,h,c]=Y(a,o);if(c<=r)return[t,"optimal",e];const f=new $(((t,e)=>t[0]-e[0]));f.push([e,[[-1,u,Math.ceil(h)]]]),f.push([e,[[1,u,Math.floor(h)]]]);const g=2*o.length,m=a.matrix.length+g*a.width,d=a.positionOfVariable.length+g;let S=j(m,d),C=j(m,d);const b=e*(1-i*l),y=p+Date.now();let v=Date.now()>=y,w=!1,E=1/0,P=a,k=0;for(;k<n&&!f.empty()&&E>=b&&!v;){const[t,e]=f.pop();if(t>E)break;const i=K(a,S,e),[n,l]=L(i,s);if("optimal"===n&&l<E){const[t,s,a]=Y(i,o);if(a<=r){w=!0,E=l,P=i;const t=C;C=S,S=t}else{const a=[],i=[];for(let s=0;s<e.length;s++){const o=e[s],[r,n]=o;n===t?r<0?i.push(o):a.push(o):(a.push(o),i.push(o))}i.push([1,t,Math.floor(s)]),a.push([-1,t,Math.ceil(s)]),f.push([l,a]),f.push([l,i])}}v=Date.now()>=y,k++}const N=(v||k>=n)&&!f.empty()&&E>=b?"timedout":w?"optimal":"infeasible";return[{...t,tableau:P},N,w?E:NaN]})(s,o,a);return Z(t,e,i,a)}},Q=[e.StatHitRating,e.StatCritRating,e.StatHasteRating,e.StatExpertiseRating,e.StatMasteryRating,e.StatDodgeRating,e.StatParryRating],tt={[e.StatMasteryRating]:()=>s(a,null,"Total ",s("strong",null,"percentage")),[e.StatHasteRating]:()=>s(a,null,"Final percentage value ",s("strong",null,"including")," all buffs/gear.")},et=class t{static canEnable(t){return t.getGear().hasTrinketFromOptions([69150,68994,69113,68972])}constructor(e,s){if(!t.relevantStats.includes(e))throw new Error("Forced highest stat must be either Crit, Haste, or Mastery!");this.forcedHighestStat=i.fromStat(e),this.constrainedStats=t.relevantStats.filter((t=>t!==e)).map((t=>i.fromStat(t))),this.constraintKeys=this.constrainedStats.map((t=>this.forcedHighestStat.getShortName(s)+"Minus"+t.getShortName(s)))}updateCoefficients(e,s,a){if(t.relevantStats.includes(s))for(const[t,i]of this.constrainedStats.entries()){const o=this.constraintKeys[t],r=e.get(o)||0;this.forcedHighestStat.equalsStat(s)?e.set(o,r+a):i.equalsStat(s)&&e.set(o,r-a)}}updateConstraints(e,s,a){for(const[i,r]of this.constrainedStats.entries()){const n=(new o).withUnitStat(this.forcedHighestStat,1).withUnitStat(r,-1);let l=1-a.computeEP(n);const p=t.procTrinketOffsets.get(r.getStat());for(const t of s.getTrinkets()){if(!t)continue;const e=t.item.id;if(p.has(e)){l+=p.get(e);break}}e.set(this.constraintKeys[i],T(l))}}};et.relevantStats=[e.StatCritRating,e.StatHasteRating,e.StatMasteryRating],et.procTrinketOffsets=new Map([[e.StatCritRating,new Map([[69167,460],[68995,410]])],[e.StatHasteRating,new Map([[69112,1730],[68927,1532]])],[e.StatMasteryRating,new Map([])]]);let st=et;class at{constructor(t,e){this.statTooltips={},this.additionalSoftCapTooltipInformation={},this.freezeItemSlotsChangeEmitter=new r,this.freezeItemSlots=!1,this.frozenItemSlots=new Map,this.previousGear=null,this.previousReforges=new Map,this.currentReforges=new Map,this.relativeStatCap=null,this.simUI=t,this.player=t.player,this.playerClass=this.player.getClass(),this.isExperimental=e?.experimental,this.isHybridCaster=[n.SpecBalanceDruid,n.SpecShadowPriest,n.SpecElementalShaman,n.SpecMistweaverMonk].includes(this.player.getSpec()),this.sim=t.sim,this.defaults=t.individualConfig.defaults,this.getEPDefaults=e?.getEPDefaults,this.updateSoftCaps=e?.updateSoftCaps,this.updateGearStatsModifier=e?.updateGearStatsModifier,this._softCapsConfig=this.defaults.softCapBreakpoints||[],this.statTooltips={...tt,...e?.statTooltips},this.additionalSoftCapTooltipInformation={...e?.additionalSoftCapTooltipInformation},this.statSelectionPresets=e?.statSelectionPresets,this._statCaps=this.statCaps,this.enableBreakpointLimits=!!e?.enableBreakpointLimits;const i={label:"Suggest Reforges",cssClass:"suggest-reforges-action-button flex-grow-1",onClick:async({currentTarget:t})=>{const e=t;e&&(e.classList.add("loading"),e.disabled=!0);try{performance.mark("reforge-optimization-start"),await this.optimizeReforges(),this.onReforgeDone()}catch(s){this.onReforgeError(s)}finally{performance.mark("reforge-optimization-end"),e&&(e.classList.remove("loading"),e.disabled=!1)}}},o={cssClass:"suggest-reforges-button-settings",children:s(a,null,s("i",{className:"fas fa-cog"}))},{group:p,children:[u,h]}=t.addActionGroup([i,o],{cssClass:l("suggest-reforges-settings-group d-flex",this.isExperimental&&!this.player.sim.getShowExperimental()&&"hide")});this.bindToggleExperimental(p),this.softCapsConfig?.length&&P(u,{theme:"suggest-reforges-softcaps",placement:"bottom",maxWidth:310,interactive:!0,onShow:t=>t.setContent(this.buildReforgeButtonTooltip())}),P(h,{placement:"bottom",content:"Change Reforge Optimizer settings"}),this.buildContextMenu(h)}bindToggleExperimental(t){const e=()=>t.classList[this.isExperimental&&!this.player.sim.getShowExperimental()?"add":"remove"]("hide");e(),this.player.sim.showExperimentalChangeEmitter.on((()=>{e()}))}get softCapsConfig(){return this.updateSoftCaps?.(p.cloneSoftCaps(this._softCapsConfig))||this._softCapsConfig}get softCapsConfigWithLimits(){if(!this.enableBreakpointLimits)return this.softCapsConfig;const t=p.cloneSoftCaps(this.softCapsConfig);for(const[e,s]of this.player.getBreakpointLimits().asUnitStatArray()){if(!s)continue;const a=t.find((t=>t.unitStat.equals(e)));a&&(a.breakpoints=a.breakpoints.filter((t=>t<=s)))}return t}get statCaps(){return this.sim.getUseCustomEPValues()?this.player.getStatCaps():this.defaults.statCaps||new o}setStatCap(t,e){return this._statCaps=this._statCaps.withUnitStat(t,e),this.sim.getUseCustomEPValues()&&this.player.setStatCaps(r.nextEventID(),this._statCaps),this.statCaps}setDefaultStatCaps(){return this._statCaps=this.defaults.statCaps||new o,this.player.setStatCaps(r.nextEventID(),this._statCaps),this.statCaps}get preCapEPs(){let t=this.sim.getUseCustomEPValues()?this.player.getEpWeights():this.getEPDefaults?.(this.player)||this.defaults.epWeights;return this.isHybridCaster&&(t=t.withStat(e.StatSpirit,.01)),t}static checkWeights(t,s,a){let o=t;for(const r of[e.StatHitRating,e.StatCritRating,e.StatHasteRating]){const e=i.getChildren(r);if(e.map((e=>t.getPseudoStat(e))).some((t=>0!==t)))o=o.withStat(r,0);else for(const n of e)if(u(n,s,a)){const e=i.fromPseudoStat(n).convertPercentToRating(t.getStat(r));o=o.withPseudoStat(n,e),o=o.withStat(r,0);break}}return o}buildReforgeButtonTooltip(){return s(a,null,s("p",null,"The following breakpoints have been implemented for this spec:"),s("table",{className:"w-100"},s("tbody",null,this.softCapsConfigWithLimits?.map((({unitStat:t,breakpoints:e,capType:i,postCapEPs:o},r)=>s(a,null,s("tr",null,s("th",{className:"text-nowrap",colSpan:2},t.getShortName(this.playerClass)),s("td",{className:"text-end"},h.get(i))),this.additionalSoftCapTooltipInformation[t.getRootStat()]&&s(a,null,s("tr",null,s("td",{colSpan:3},this.additionalSoftCapTooltipInformation[t.getRootStat()]?.())),s("tr",null,s("td",{colSpan:3,className:"pb-2"}))),s("tr",null,s("th",{className:"text-end"},s("em",null,"%")),s("th",{colSpan:2,className:"text-nowrap text-end"},s("em",null,"Post cap EP"))),e.map(((e,a)=>s("tr",null,s("td",{className:"text-end"},this.breakpointValueToDisplayPercentage(e,t)),s("td",{colSpan:2,className:"text-end"},t.convertEpToRatingScale(i===c.TypeThreshold?o[0]:o[a]).toFixed(2))))),r!==this.softCapsConfigWithLimits.length-1&&s(a,null,s("tr",null,s("td",{colSpan:3,className:"border-bottom pb-2"})),s("tr",null,s("td",{colSpan:3,className:"pb-2"})))))))))}setFreezeItemSlots(t,e){this.freezeItemSlots!==e&&(this.freezeItemSlots=e,this.frozenItemSlots.clear(),this.freezeItemSlotsChangeEmitter.emit(t))}buildContextMenu(t){const e=P(t,{interactive:!0,trigger:"click",theme:"reforge-optimiser-popover",placement:"right-start",onShow:t=>{const e=new f(null,this.player,{id:"reforge-optimizer-enable-custom-ep-weights",label:"Use custom EP Weights",inline:!0,changedEvent:()=>this.sim.useCustomEPValuesChangeEmitter,getValue:()=>this.sim.getUseCustomEPValues(),setValue:(t,e,s)=>{this.sim.setUseCustomEPValues(t,s)}});let o=null;this.softCapsConfig?.length&&(o=new f(null,this.player,{id:"reforge-optimizer-enable-soft-cap-breakpoints",label:"Use soft cap breakpoints",inline:!0,changedEvent:()=>this.sim.useSoftCapBreakpointsChangeEmitter,getValue:()=>this.sim.getUseSoftCapBreakpoints(),setValue:(t,e,s)=>{this.sim.setUseSoftCapBreakpoints(t,s)}}));const r=new N(null,this.player,{id:"reforge-optimizer-force-stat-proc",label:"Force Matrix/Apparatus proc",values:[{name:"Any",value:-1},...[...st.relevantStats].map((t=>({name:i.fromStat(t).getShortName(this.playerClass),value:t})))],changedEvent:()=>this.player.gearChangeEmitter,getValue:()=>this.relativeStatCap?this.relativeStatCap.forcedHighestStat.getStat():-1,setValue:(t,e,s)=>{this.relativeStatCap=-1==s?null:new st(s,this.playerClass)},showWhen:()=>{const t=st.canEnable(this.player);return t||(this.relativeStatCap=null),t}}),n=new f(null,this.player,{id:"reforge-optimizer-freeze-item-slots",label:"Freeze item slots",labelTooltip:'Flag one or more item slots to be "frozen", which will prevent the optimizer from changing the Reforge in that slot from its current setting. This can be useful for hybrid classes who use the same gear piece for multiple raid roles.',inline:!0,changedEvent:()=>this.freezeItemSlotsChangeEmitter,getValue:()=>this.freezeItemSlots,setValue:(t,e,s)=>{this.setFreezeItemSlots(t,s)}}),p=g();t.setContent(s(a,null,e.rootElem,s("div",{ref:p,className:l("mb-0",this.sim.getUseCustomEPValues()&&"hide")},s("p",null,"This will enable modification of the default EP weights and setting custom stat caps."),s("p",null,"Ep weights can be modified in the Stat Weights editor."),s("p",null,"If you want to hard cap a stat make sure to put the EP for that stat higher.")),this.buildCapsList({useCustomEPValuesInput:e,description:p.value}),o?.rootElem,r.rootElem,this.buildSoftCapBreakpointsLimiter({useSoftCapBreakpointsInput:o}),n.rootElem,this.buildFrozenSlotsInputs(),this.buildEPWeightsToggle({useCustomEPValuesInput:e})))},onHidden:()=>{e.setContent(s(a,null))}})}buildFrozenSlotsInputs(){const t=this.player.getGear().getItemSlots(),e=Math.floor(t.length/2)+1,a=[];for(let s=0;s<e;s++)a.push(t.slice(2*s,2*(s+1)));const i=g();return s("table",{ref:i},a.map((t=>{const e=g();return s("tr",{ref:e},t.map((t=>{const e=new f(null,this.player,{id:"reforge-optimizer-freeze-"+d[t],label:m.get(t),inline:!0,changedEvent:()=>this.freezeItemSlotsChangeEmitter,getValue:()=>this.frozenItemSlots.get(t)||!1,setValue:(e,s,a)=>{this.frozenItemSlots.set(t,a)},showWhen:()=>this.freezeItemSlots});return s("td",null,e.rootElem)})))})))}buildCapsList({useCustomEPValuesInput:t,description:e}){const i={changedEvent:t=>r.onAny([this.sim.useSoftCapBreakpointsChangeEmitter,this.player.statCapsChangeEmitter])},o=g(),n=g(),p=g(),u=s("table",{ref:o,className:l("reforge-optimizer-stat-cap-table mb-2",!this.sim.getUseCustomEPValues()&&"hide")},s("thead",null,s("tr",null,s("th",{colSpan:3,className:"pb-3"},s("div",{className:"d-flex"},s("h6",{className:"content-block-title mb-0 me-1"},"Edit stat caps"),s("button",{ref:n,className:"d-inline"},s("i",{className:"fa-regular fa-circle-question"})),s("button",{ref:p,className:"d-inline ms-auto",onclick:()=>this.setDefaultStatCaps()},s("i",{className:"fas fa-arrow-rotate-left"}))))),s("tr",null,s("th",null,"Stat"),s("th",{colSpan:2,className:"text-end"},"%"))),s("tbody",null,this.simUI.individualConfig.displayStats.map((e=>{if(!e.hasRootStat())return;const o=e.getRootStat();if(!Q.includes(o))return;const r=g(),n=e.getShortName(this.player.getClass()),l={getValue:()=>this.toVisualUnitStatPercentage(this.statCaps.getUnitStat(e),e),setValue:(t,s,a)=>{this.setStatCap(e,this.toDefaultUnitStatValue(a,e))}},p=new M(null,this.player,{id:`reforge-optimizer-${n}-percentage`,float:!0,maxDecimalDigits:5,showZeroes:!1,positive:!0,extraCssClasses:["mb-0"],enableWhen:()=>this.isAllowedToOverrideStatCaps||!this.softCapsConfig.some((t=>t.unitStat.equals(e))),...i,...l}),u=this.statSelectionPresets?.find((t=>t.unitStat.equals(e)))?.presets,h=u?new N(null,this.player,{id:`reforge-optimizer-${n}-presets`,extraCssClasses:["mb-0"],label:"",values:[{name:"Select preset",value:0},...[...u.keys()].map((t=>{const e=u.get(t);return{name:`${t} - ${e.toFixed(2)}%`,value:e}}))].sort(((t,e)=>t.value-e.value)),enableWhen:()=>this.isAllowedToOverrideStatCaps||!this.softCapsConfig.some((t=>t.unitStat.equals(e))),...i,...l}):null,c=this.statTooltips[o],f=g(),m=s(a,null,s("tr",{ref:r,className:"reforge-optimizer-stat-cap-item"},s("td",null,s("div",{className:"reforge-optimizer-stat-cap-item-label"},n," ",c&&s("button",{ref:f,className:"d-inline"},s("i",{className:"fa-regular fa-circle-question"})))),s("td",{colSpan:2},p.rootElem)),h&&s("tr",null,s("td",null),s("td",{colSpan:2},h.rootElem))),d=c?P(f.value,{content:c}):null;return t.addOnDisposeCallback((()=>d?.destroy())),m}))));if(n.value){const e=P(n.value,{content:"Stat caps are the maximum amount of a stat that can be gained from Reforging. If a stat exceeds its cap, the optimizer will attempt to reduce it to the cap value."});t.addOnDisposeCallback((()=>e.destroy()))}if(p.value){const e=P(p.value,{content:"Reset to stat cap defaults"});t.addOnDisposeCallback((()=>e.destroy()))}const h=this.sim.useCustomEPValuesChangeEmitter.on((()=>{const t=this.sim.getUseCustomEPValues();o.value?.classList[t?"remove":"add"]("hide"),e?.classList[t?"add":"remove"]("hide")}));return t.addOnDisposeCallback((()=>{u.remove(),h.dispose()})),u}buildEPWeightsToggle({useCustomEPValuesInput:t}){const e=["mt-3"];this.sim.getUseCustomEPValues()||e.push("hide");const i=x(null,this.simUI,{extraCssClasses:e,loadOnly:!0}),o=this.sim.useCustomEPValuesChangeEmitter.on((()=>{const t=this.sim.getUseCustomEPValues();i.rootElem?.classList[t?"remove":"add"]("hide")}));return t.addOnDisposeCallback((()=>{i.dispose(),i.rootElem.remove(),o.dispose()})),s(a,null,i.rootElem,this.simUI.epWeightsModal&&s("button",{className:"btn btn-outline-primary",onclick:()=>{this.simUI.epWeightsModal?.open(),k()}},"Edit weights"))}buildSoftCapBreakpointsLimiter({useSoftCapBreakpointsInput:t}){if(!this.enableBreakpointLimits||!t)return null;const e=g(),i=g(),o=s("table",{ref:e,className:l("reforge-optimizer-stat-cap-table mb-2",!this.sim.getUseSoftCapBreakpoints()&&"hide")},s("thead",null,s("tr",null,s("th",{colSpan:3,className:"pb-3"},s("div",{className:"d-flex"},s("h6",{className:"content-block-title mb-0 me-1"},"Breakpoint limit"),s("button",{ref:i,className:"d-inline"},s("i",{className:"fa-regular fa-circle-question"})))))),s("tbody",null,this.softCapsConfig.filter((t=>t.capType===c.TypeThreshold&&t.breakpoints.length>1)).map((({breakpoints:t,unitStat:e})=>{if(!e.hasRootStat())return;const i=e.getRootStat();if(!Q.includes(i))return;const o=g(),n=e.getShortName(this.player.getClass()),l=t?new N(null,this.player,{id:`reforge-optimizer-${n}-presets`,extraCssClasses:["mb-0"],label:"",values:[{name:"No limit set",value:0},...t.map((t=>({name:`${this.breakpointValueToDisplayPercentage(t,e)}%`,value:t})))].sort(((t,e)=>t.value-e.value)),changedEvent:t=>r.onAny([this.sim.useSoftCapBreakpointsChangeEmitter]),getValue:()=>this.player.getBreakpointLimits().getUnitStat(e)||0,setValue:(t,s,a)=>{this.player.setBreakpointLimits(t,this.player.getBreakpointLimits().withUnitStat(e,a))}}):null;if(!l?.rootElem)return null;return s(a,null,s("tr",{ref:o,className:"reforge-optimizer-stat-cap-item"},s("td",null,s("div",{className:"reforge-optimizer-stat-cap-item-label"},n)),s("td",{colSpan:2},l.rootElem)))}))));if(i.value){const e=P(i.value,{content:"Allows you to set a custom breakpoint limit."});t.addOnDisposeCallback((()=>e.destroy()))}const n=this.sim.useSoftCapBreakpointsChangeEmitter.on((()=>{const t=this.sim.getUseSoftCapBreakpoints();e.value?.classList[t?"remove":"add"]("hide")}));return t.addOnDisposeCallback((()=>{o.remove(),n?.dispose()})),o}get isAllowedToOverrideStatCaps(){return!(this.sim.getUseSoftCapBreakpoints()&&this.softCapsConfig)}get processedStatCaps(){let t=this.statCaps;return this.isAllowedToOverrideStatCaps||this.softCapsConfigWithLimits.forEach((({unitStat:e})=>{t=t.withUnitStat(e,0)})),t}async optimizeReforges(){this.previousGear=this.player.getGear(),this.previousReforges=this.previousGear.getAllReforges();const t=this.previousGear.withoutReforges(this.player.canDualWield2H(),this.frozenItemSlots),e=await this.updateGear(t),s=e.computeStatCapsDelta(this.processedStatCaps),a=this.computeReforgeSoftCaps(e),i=at.checkWeights(this.preCapEPs,s,a),o=this.buildYalpsVariables(t,i),r=this.buildYalpsConstraints(t,e);await this.solveModel(t,i,s,a,o,r,75e3),this.currentReforges=this.player.getGear().getAllReforges()}async updateGear(t){this.player.setGear(r.nextEventID(),t),await this.sim.updateCharacterStats(r.nextEventID());let s=o.fromProto(this.player.getCurrentStats().finalStats);return s=s.addStat(e.StatMasteryRating,this.player.getBaseMastery()*S),this.updateGearStatsModifier&&(s=this.updateGearStatsModifier(s)),s}computeReforgeSoftCaps(t){const e=[];return this.isAllowedToOverrideStatCaps||this.softCapsConfigWithLimits.slice().forEach((s=>{let a=s.postCapEPs.slice();const i=[];for(const e of s.breakpoints)i.push(t.computeGapToCap(s.unitStat,e));s.capType==c.TypeThreshold&&(i.reverse(),a=Array(i.length).fill(a[0])),e.push(new p(s.unitStat,i,s.capType,a))})),e}buildYalpsVariables(t,s){const a=new Map,i=this.simUI.individualConfig.epStats;for(const o of t.getItemSlots()){const r=t.getEquippedItem(o);if(r&&!this.frozenItemSlots.get(o))for(const t of this.player.getAvailableReforgings(r.withDynamicStats())){if(!i.includes(t.toStat)&&t.toStat!=e.StatExpertiseRating)continue;const r=`${o}_${t.id}`,n=new Map;n.set(d[o],1),this.applyReforgeStat(n,t.fromStat,t.fromAmount,s),this.applyReforgeStat(n,t.toStat,t.toAmount,s),a.set(r,n)}}return a}applyReforgeStat(t,s,a,o){if((s==e.StatSpirit&&this.isHybridCaster||s==e.StatExpertiseRating)&&this.setPseudoStatCoefficient(t,C.PseudoStatSpellHitPercent,a/b),this.relativeStatCap?.updateCoefficients(t,s,a),0==o.getStat(s))for(const e of i.getChildren(s))0!=o.getPseudoStat(e)&&this.setPseudoStatCoefficient(t,e,i.fromPseudoStat(e).convertRatingToPercent(a));else t.set(e[s],a)}setPseudoStatCoefficient(t,e,s){const a=t.get(C[e])||0;t.set(C[e],a+s)}buildYalpsConstraints(t,s){const a=new Map;for(const e of t.getItemSlots())a.set(d[e],{max:1});if(this.relativeStatCap){const i=s.addStat(e.StatMasteryRating,-this.player.getBaseMastery()*S);this.relativeStatCap.updateConstraints(a,t,i)}return a}async solveModel(t,e,s,a,i,o,r){const n=this.updateReforgeScores(i,e),l=X({objective:"score",constraints:o,variables:n},{timeout:1/0,maxIterations:r,tolerance:.01});if(isNaN(l.result)){if(r>5e5)throw l;return await this.solveModel(t,e,s,a,i,o,2*r)}const p=await this.applyLPSolution(t,l),[u,h,c]=this.checkCaps(l,s,a,n,o,e);return u?(await y(100),await this.solveModel(p,c,s,a,n,h,r)):l.result}updateReforgeScores(t,s){const a=new Map;for(const[i,o]of t.entries()){let t=0;const r=new Map;for(const[a,i]of o.entries())if(r.set(a,i),a.includes("PseudoStat")){const e=C[a];t+=s.getPseudoStat(e)*i}else if(a.includes("Stat")){const o=e[a];t+=s.getStat(o)*i}r.set("score",t),a.set(i,r)}return a}async applyLPSolution(t,e){let s=t.withoutReforges(this.player.canDualWield2H(),this.frozenItemSlots);for(const[a,i]of e.variables){const e=a.split("_"),i=parseInt(e[0]),o=parseInt(e[1]),r=t.getEquippedItem(i);r&&(s=s.withEquippedItem(i,r.withReforge(this.sim.db.getReforgeById(o)),this.player.canDualWield2H()))}return await this.updateGear(s),s}checkCaps(t,s,a,i,r,n){let l=new o;for(const[o,c]of t.variables)for(const[t,s]of i.get(o).entries())if(t.includes("PseudoStat")){const e=C[t];l=l.addPseudoStat(e,s)}else if(t.includes("Stat")){const a=e[t];l=l.addStat(a,s)}let p=!1;const u=new Map(r);let h=n;for(const[e,o]of l.asUnitStatArray()){const t=s.getUnitStat(e),a=e.getKey();0!==t&&o>t&&!r.has(a)&&(u.set(a,T(t)),p=!0,h=h.withUnitStat(e,0))}for(;!p&&a.length>0;){const t=a[0],e=t.unitStat,s=e.getKey(),i=l.getUnitStat(e);let o=0;for(const a of t.breakpoints){if(i>a){u.set(s,T(a)),h=h.withUnitStat(e,t.postCapEPs[o]),p=!0;break}o++}t.capType==c.TypeSoftCap&&(t.breakpoints=t.breakpoints.slice(o+1),t.postCapEPs=t.postCapEPs.slice(o+1)),t.capType!=c.TypeThreshold&&0!=t.breakpoints.length||a.shift()}return[p,u,h]}get baseMastery(){return this.player.getBaseMastery()*S}toVisualTotalMasteryPercentage(t,e){return e-this.baseMastery<=0?t=0:t*=this.player.getMasteryPerPointModifier(),t}toVisualUnitStatPercentage(t,s){const a=t;let i=s.convertDefaultUnitsToPercent(a);return s.equalsStat(e.StatMasteryRating)&&(i=this.toVisualTotalMasteryPercentage(i,a)),i}toDefaultUnitStatValue(t,s){let a=s.convertPercentToDefaultUnits(t);return s.equalsStat(e.StatMasteryRating)&&(a/=this.player.getMasteryPerPointModifier()),a}breakpointValueToDisplayPercentage(t,s){return s.equalsStat(e.StatMasteryRating)?(t/S*this.player.getMasteryPerPointModifier()).toFixed(2):s.convertDefaultUnitsToPercent(t).toFixed(2)}onReforgeDone(){const t=this.player.getGear().getItemSlots(),e=new Map;for(const s of t){const t=this.previousReforges.get(s),a=this.currentReforges.get(s);v.equals(t?.reforge,a?.reforge)||e.set(s,a)}const i=e.size,o=g(),r=s(a,null,s("p",{className:"mb-0"},"The following items were reforged:"),s("ul",null,[...e].map((([t,e])=>{if(e){const a=m.get(t),{fromStat:i,toStat:o}=e,r=w.get(i),n=w.get(o);return s("li",null,a,": ",r," → ",n)}return s("li",null,m.get(t),": Removed reforge")}))),s("div",{ref:o}));if(i){const t=E.toJson(this.simUI.toProto());t&&new R(o.value,{extraCssClasses:["btn-outline-primary"],getContent:()=>JSON.stringify(t),text:"Copy to Reforge Lite"})}new I({variant:"success",body:i?r:s(a,null,"No reforge changes were made!"),delay:i?5e3:3e3})}onReforgeError(t){this.previousGear&&this.updateGear(this.previousGear),new I({variant:"error",body:"Reforge optimization failed. Please try again, or report the issue if it persists."})}}export{at as R};
